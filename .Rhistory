labels = c("Haloperidol", "Risperidone")
)
if ("Treatment" %in% colnames(data) && "Dosage" %in% colnames(data)) {
lmeFit <- lme(logPANSS ~ Time + Treatment + Dosage,
random = ~ Time | ID,
data = longitudinal_data,
control = lmeControl(opt = "optim"))
coxFit <- coxph(Surv(dropout_time, dropout_status) ~ Treatment + Dosage ,
data = survival_data, x = TRUE)
} else {
warning("Treatment or Dosage not found. Fitting model without covariates.")
lmeFit <- lme(logPANSS ~ Time,
random = ~ Time | ID,
data = longitudinal_data,
control = lmeControl(opt = "optim"))
coxFit <- coxph(Surv(dropout_time, dropout_status) ~ 1,
data = survival_data, x = TRUE)
}
# Fit the joint model with piecewise-constant PH model
jointFit <- jointModel(lmeFit, coxFit, timeVar = "Time",
method = "spline-PH-GH")
# Summary of the joint model
summary(jointFit)
###########Joint model in INLA by Janet (code before this is a two stage model, not a joint model)
if (!require("INLAjoint", character.only = TRUE)) {
devtools::install_github('DenisRustand/INLAjoint', build_vignettes = FALSE)
library("INLAjoint", character.only = TRUE)
}
survival_data$visit_times <- NULL
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time|ID),
dataLong = longitudinal_data,
#    dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage ,
dataLong = longitudinal_data,
#    dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
summary(longitudinal_data)
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time +  Dosage ,
dataLong = longitudinal_data,
#    dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Treatment + Dosage ,
dataLong = longitudinal_data,
#    dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time|ID),
dataLong = longitudinal_data,
#    dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time ,
dataLong = longitudinal_data,
#    dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
#    formLong = logPANSS ~ Time + Treatment + Dosage + (Time|ID),
#    dataLong = longitudinal_data,
dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time|ID),
#    dataLong = longitudinal_data,
dataSurv = survival_data,
#   assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time|ID),
#    dataLong = longitudinal_data,
dataSurv = survival_data,
assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time|ID),
dataLong = longitudinal_data,
dataSurv = survival_data,
assoc = c("CV"),
id = "ID",
timeVar = "Time")
longitudinal_data
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
dataSurv = survival_data,
assoc = c("CV"),
id = "ID",
timeVar = "Time")
# ---------------------------------------------------------
# Load required libraries
# ---------------------------------------------------------
library(readxl)
library(dplyr)
library(tidyr)
library(nlme)
library(survival)
library(JM)
# ---------------------------------------------------------
# STEP 1: Load and clean data
# ---------------------------------------------------------
setwd("/Users/janet/Google Drive/My Drive/Research/JM Nkululeko")
data <- read_excel("Schizophrenia Data Set.xlsx")
# Replace NA with 0
data <- data %>% dplyr::mutate_all(~replace(., is.na(.), 0))
# Compute log(PANSS + 1) â€“ safer than log(PANSS)
data <- data %>% dplyr::mutate(logPANSS = log(PANSS))
# ---------------------------------------------------------
# STEP 2: Build survival_data (now includes avg PANSS & avg logPANSS)
# ---------------------------------------------------------
survival_data <- data %>%
dplyr::group_by(ID) %>%
dplyr::summarise(
visit_times    = list(Time),
n_visits       = dplyr::n(),
last_time      = max(Time),
Treatment      = dplyr::first(Treatment),
Dosage         = dplyr::first(Dosage),
# NEW VARIABLES
avgPANSS       = mean(PANSS, na.rm = TRUE),
avgLogPANSS    = mean(logPANSS, na.rm = TRUE),
dropout_time = {
expected_times <- 0:6
observed_times <- Time
if (n_visits < 7) {
missing_times <- setdiff(expected_times, observed_times)
if (length(missing_times) > 0 &&
any(observed_times < min(missing_times))) {
max(observed_times[observed_times < min(missing_times)])
} else {
last_time
}
} else {
6   # no dropout
}
},
dropout_status = as.numeric(n_visits < 7),
.groups = "drop"
) %>%
dplyr::ungroup() %>%
dplyr::mutate(
Treatment = as.factor(Treatment),
Dosage = as.numeric(Dosage),
dropout_time = as.numeric(dropout_time),
dropout_status = as.numeric(dropout_status),
# Clean invalid dropout times
dropout_time = ifelse(!is.finite(dropout_time) | dropout_time <= 0,
0.001, dropout_time),
dropout_status = ifelse(is.na(dropout_status), 0, dropout_status)
)
# ---------------------------------------------------------
# STEP 3: Filter longitudinal data up to dropout_time
# ---------------------------------------------------------
longitudinal_data <- data %>%
dplyr::left_join(
survival_data %>% dplyr::select(ID, dropout_time),
by = "ID"
) %>%
dplyr::mutate(
dropout_time = ifelse(is.na(dropout_time), max(Time), dropout_time)
) %>%
dplyr::filter(Time <= dropout_time)
# ---------------------------------------------------------
# STEP 4: Build missingness structure (optional)
# ---------------------------------------------------------
expected_times <- 0:6
complete_visits <- longitudinal_data %>%
dplyr::distinct(ID, Treatment, Dosage) %>%
tidyr::expand_grid(Time = expected_times)
missingness_data <- complete_visits %>%
dplyr::left_join(
longitudinal_data %>% dplyr::select(ID, Time, PANSS, Treatment, Dosage),
by = c("ID", "Time", "Treatment", "Dosage")
) %>%
dplyr::mutate(
Missingness = ifelse(is.na(PANSS), 1, 0),
MaxVisits = length(expected_times)
) %>%
dplyr::arrange(ID, Time)
# ---------------------------------------------------------
# STEP 5: Add dropout pattern grouping to longitudinal data
# ---------------------------------------------------------
pattern_df <- survival_data %>%
dplyr::select(ID, dropout_time, n_visits) %>%
dplyr::mutate(
pattern_time = dropout_time,
pattern_grp = dplyr::case_when(
n_visits == 7            ~ "completer",
n_visits >= 4 & n_visits < 7 ~ "mid_dropout",
n_visits < 4             ~ "early_dropout",
TRUE                     ~ "unknown"
)
)
long_with_pattern <- longitudinal_data %>%
dplyr::left_join(pattern_df, by = "ID") %>%
dplyr::mutate(
pattern_grp = factor(pattern_grp,
levels = c("completer", "mid_dropout", "early_dropout", "unknown")),
pattern_time = as.factor(pattern_time),
Time = as.numeric(Time),
Dosage = as.numeric(Dosage),
Treatment = as.factor(Treatment)
)
if ("dropout_time" %in% colnames(longitudinal_data)) {
longitudinal_data <- longitudinal_data %>% dplyr::select(-dropout_time)
}
longitudinal_data$Treatment <- factor(
longitudinal_data$Treatment,
levels = c(1, 2),
labels = c("Haloperidol", "Risperidone")
)
survival_data$Treatment <- factor(
survival_data$Treatment,
levels = c(1, 2),
labels = c("Haloperidol", "Risperidone")
)
if ("Treatment" %in% colnames(data) && "Dosage" %in% colnames(data)) {
lmeFit <- lme(logPANSS ~ Time + Treatment + Dosage,
random = ~ Time | ID,
data = longitudinal_data,
control = lmeControl(opt = "optim"))
coxFit <- coxph(Surv(dropout_time, dropout_status) ~ Treatment + Dosage ,
data = survival_data, x = TRUE)
} else {
warning("Treatment or Dosage not found. Fitting model without covariates.")
lmeFit <- lme(logPANSS ~ Time,
random = ~ Time | ID,
data = longitudinal_data,
control = lmeControl(opt = "optim"))
coxFit <- coxph(Surv(dropout_time, dropout_status) ~ 1,
data = survival_data, x = TRUE)
}
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
dataSurv = survival_data,
assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
#    formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
#    dataLong = longitudinal_data,
dataSurv = survival_data,
assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
#    formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
#    dataLong = longitudinal_data,
dataSurv = survival_data,
#    assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
dataSurv = survival_data,
assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
# dataSurv = survival_data,
# assoc = c("CV"),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
# dataSurv = survival_data,
# assoc = c("CV"),
id = "ID",
timeVar = "Time")
longitudinal_data$ID2 <- longitudinal_data$ID
res1 <- inla(logPANSS ~ Time + Treatment + Dosage + + f(ID, model = "iid") + f(ID2, Time, model = "iid"),
data = longitudinal_data)
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
# dataSurv = survival_data,
# assoc = c("CV"),
# id = "ID",
timeVar = "Time")
# timeVar = "Time")
res_inla_joint <- joint(#formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
# dataSurv = survival_data,
# assoc = c("CV"),
id = "ID",
# timeVar = "Time"
)
res_inla_joint <- joint(formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
id = "ID")
res1 <- inla(logPANSS ~ Time + Treatment + Dosage + + f(ID, model = "iid") + f(ID2, Time, model = "iid"),
data = longitudinal_data)
res_inla_joint <- joint(formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
dataLong = longitudinal_data,
id = "ID")
summary(res1)
summary(longitudinal_data)
res_inla_joint <- joint(formLong = logPANSS ~ Time + Treatment + Dosage + (1 + Time | ID),
dataLong = longitudinal_data,
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
# formLong = logPANSS ~ Time + Treatment + Dosage + (Time | ID),
# dataLong = longitudinal_data,
dataSurv = survival_data,
# assoc = c("CV"),
id = "ID",
# timeVar = "Time"
)
saveRDS(longitudinal_data, file = "long_data.rds")
res_inla_joint <- joint(formLong = logPANSS ~ Time + Treatment + Dosage + (1 + Time | ID),
dataLong = data.frame(longitudinal_data),
id = "ID",
timeVar = "Time")
res_inla_joint <- joint(formSurv = INLA::inla.surv(time = dropout_time, event = dropout_status) ~ Treatment + Dosage,
formLong = logPANSS ~ Time + Treatment + Dosage + (1 + Time | ID),
dataLong = data.frame(longitudinal_data),
dataSurv = data.frame(survival_data),
assoc = c("CV"),
id = "ID",
timeVar = "Time"
)
summary(res_inla_joint)
library(graphpcor)
library(INLA)
## the model as 'graphpcor'
gph_model <- graphpcor(
graph = matrix(1, 3, 3) ## dense
)
## base model (base correlation matrix)
C0 <- matrix(c(1,0.5,0.5,0.5,1,0.4,0.5,0.4,1), nrow = 3)
## Hessian around a base model
Ith0 <- hessian(gph_model, C0)
str(Ith0)
th0 <- attr(Ith0,'base')
vcov(gph_model, theta = th0)
h.5 <- solve(attr(Ith0,'hneg.5'))
(dh.5 <- prod(attr(Ith0,'decomposition')$values^0.5))
h <- 0.01
th0s <- seq(-1.5+h/2, 1.5-h/2, h)
th0x <- t(expand.grid(th0s, th0s, th0s)) ## each column ...
ncol(th0x)/1e6 ## size of the grid
R <- sqrt(colSums( (h.5 %*% th0x)^2 ))
Sr <- 2 * (pi^(3/2)) * R^2 / gamma(3/2)
param <- 5
dthR <- param * exp(-param * R) * dh.5 / Sr
## define a`cgeneric`
library(INLAtools)
c_model <- cgeneric(
model = gph_model,
lambda = param,
base = C0,
useINLAprecomp = FALSE) ## under development version
update(graphpcor())
update.packages("graphpcor")
library(graphpcor)
library(INLA)
## the model as 'graphpcor'
gph_model <- graphpcor(
graph = matrix(1, 3, 3) ## dense
)
## base model (base correlation matrix)
C0 <- matrix(c(1,0.5,0.5,0.5,1,0.4,0.5,0.4,1), nrow = 3)
## Hessian around a base model
Ith0 <- hessian(gph_model, C0)
str(Ith0)
th0 <- attr(Ith0,'base')
vcov(gph_model, theta = th0)
h.5 <- solve(attr(Ith0,'hneg.5'))
(dh.5 <- prod(attr(Ith0,'decomposition')$values^0.5))
h <- 0.01
th0s <- seq(-1.5+h/2, 1.5-h/2, h)
th0x <- t(expand.grid(th0s, th0s, th0s)) ## each column ...
ncol(th0x)/1e6 ## size of the grid
R <- sqrt(colSums( (h.5 %*% th0x)^2 ))
Sr <- 2 * (pi^(3/2)) * R^2 / gamma(3/2)
param <- 5
dthR <- param * exp(-param * R) * dh.5 / Sr
## define a`cgeneric`
library(INLAtools)
c_model <- cgeneric(
model = gph_model,
lambda = param,
base = C0,
useINLAprecomp = FALSE) ## under development version
library(INLAtools)
c_model <- cgeneric(
model = gph_model,
lambda = param,
base = C0,
useINLAprecomp = FALSE) ## under development version
## check: evaluate at the base model
class(c_model) <- "cgeneric"
library(INLA)
library(graphpcor)
library(INLAtools)
## the model as 'graphpcor'
gph_model <- graphpcor(
graph = matrix(1, 3, 3) ## dense
)
## base model (base correlation matrix)
C0 <- matrix(c(1,0.5,0.5,0.5,1,0.4,0.5,0.4,1), nrow = 3)
## Hessian around a base model
Ith0 <- hessian(gph_model, C0)
str(Ith0)
th0 <- attr(Ith0,'base')
vcov(gph_model, theta = th0)
h.5 <- solve(attr(Ith0,'hneg.5'))
(dh.5 <- prod(attr(Ith0,'decomposition')$values^0.5))
h <- 0.01
th0s <- seq(-1.5+h/2, 1.5-h/2, h)
th0x <- t(expand.grid(th0s, th0s, th0s)) ## each column ...
ncol(th0x)/1e6 ## size of the grid
R <- sqrt(colSums( (h.5 %*% th0x)^2 ))
Sr <- 2 * (pi^(3/2)) * R^2 / gamma(3/2)
param <- 5
dthR <- param * exp(-param * R) * dh.5 / Sr
## define a`cgeneric`
library(INLAtools)
c_model <- cgeneric(
model = gph_model,
lambda = param,
base = C0,
useINLAprecomp = FALSE) ## under development version
knitr::opts_chunk$set(
echo = FALSE,
include = TRUE,
message = FALSE,
warning = FALSE,
fig.align='center',
fig.width = 7,
fig.height = 4,
out.width = '0.59\\textwidth')
library(graphpcor)
library(plot3D)
install.packages("plot3D")
drho <- function(rho, rho0, l) {
x0 <- atanh(rho0)
I0 <- 1-rho0^2
x <- atanh(rho)
sI0 <- sqrt(I0)
xi <- sI0 * (x - x0)
ld <- log(l*sI0/2) -l*abs(xi) -log(1-rho^2)
exp(ld)
}
rho0s <- c(-0.5, 0, 0.7)
if(FALSE)
sapply(rho0s, function(r)
sapply(lseq, function(l)
integrate(function(x) drho(x,r,l),-1,1)$val))
par(mfrow = c(1, 3), mar = c(4,4,1,1), mgp = c(3,1,0), las = 1)
for(k in 1:3) {
plot(function(x) drho(x,rho0s[k],lseq[nl]),
-1, 1, n=1001, type = "n", bty = "n",
xlab = expression(rho),
ylab = expression(pi[rho](rho~"|"~lambda~","~rho[0])))
for(i in 1:nl) {
plot(function(x) drho(x, rho0s[k], lseq[i]),
-1, 1, n=1001, add = TRUE, col = lcol[i], lty = i, lwd = 2)
}
}
knitr::opts_chunk$set(
echo = FALSE,
include = TRUE,
message = FALSE,
warning = FALSE,
fig.align='center',
fig.width = 7,
fig.height = 4,
out.width = '0.59\\textwidth')
library(graphpcor)
library(plot3D)
setwd("~/Documents/GitHub/UP_Hons_Projects.github.io")
quarto::quarto_render()
quarto::quarto_render()
setwd("~/Documents/GitHub/UP_Hons_Projects.github.io")
quarto::quarto_render()
setwd("~/Documents/GitHub/UP_Hons_Projects.github.io")
quarto::quarto_render()
quarto::quarto_render()
quarto::quarto_render()
quarto::quarto_render()
quarto::quarto_render()
quarto::quarto_render()
quarto::quarto_render()
quarto::quarto_render()
quarto::quarto_render()
